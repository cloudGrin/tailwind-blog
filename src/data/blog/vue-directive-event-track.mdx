---
title: Vueæ›å…‰ç»Ÿè®¡æŒ‡ä»¤
date: '2020-05-17'
tags: ['Javascript','Vue']
draft: false
summary: VueæŒ‡ä»¤å®ç°æ›å…‰åŸ‹ç‚¹
---

![bird](https://cloudgrin.oss-cn-shanghai.aliyuncs.com/images/big_intersection_observer.jpeg?x-oss-process=image/resize,w_600,limit_0)

ä»€ä¹ˆæ—¶å€™éœ€è¦åŸ‹ç‚¹ï¼š
---------

*   å½“ä¸€æ¬¾æ–°äº§å“è§„åˆ’å®Œæˆéœ€è¦çœ‹æ•°æ®æ—¶ï¼›
    
*   æŸä¸ªåŠŸèƒ½æ”¹ç‰ˆè§„åˆ’å®Œæˆéœ€è¦çœ‹æ•°æ®æ—¶ï¼›
    
*   ABTest éœ€è¦åˆ¤æ–­å“ªç§æ–¹æ¡ˆæ›´å¥½æ—¶ï¼›
    
*   éœ€è¦çœ‹ H5 æ´»åŠ¨é¡µçš„ç»Ÿè®¡æ•°æ®æ—¶ï¼›
    
*   éœ€è¦çœ‹ç¬¬ä¸‰æ–¹æŠ•æ”¾çš„å¼•æµæ•ˆæœæ—¶ï¼›
    
*   ä»¥åŠä»Šå¤©æˆ‘ä»¬å°†è°ˆè®ºçš„å¹¿å‘Šä½æ›å…‰åŸ‹ç‚¹ï¼›
    
*   ...
    

éœ€æ±‚
--

æˆ‘å¸ä¸»è¦æ˜¯åšç”µå•†ä¸šåŠ¡ï¼Œæœ€è¿‘å–å‡ºå»äº†ä¸€äº›å¹¿å‘Šä½ï¼Œæƒ³è¦ç»Ÿè®¡è¿™äº›å¹¿å‘Šä½çš„æ›å…‰æƒ…å†µï¼Œç„¶åå°±å¯ä»¥ç†ç›´æ°”å£®çš„æ‹¿å‡ºæ•°æ®å‘å•†å®¶æ”¶é’±äº†ã€‚

äº§å“æå‡ºéœ€æ±‚æ–¹æ¡ˆæ˜¯å¹¿å‘Šä½æ¼å‡º 1/4 ä¸”è¿ç»­æ—¶é—´è¾¾åˆ° 2 ç§’ï¼Œå¹¿å‘Šä½ç±»å‹ä¸»è¦æ˜¯è½®æ’­å’Œ bannerã€‚

æ–¹æ¡ˆ
--

*   ç›‘å¬æ»šåŠ¨ï¼ˆèŠ‚æµï¼‰ï¼Œå®æ—¶è®¡ç®—å¹¿å‘Šä½ä¸è§†çª—çš„ä½ç½®ã€‚
    
*   ä½¿ç”¨å®šæ—¶å™¨å®šæ—¶è®¡ç®—é¡µé¢å¹¿å‘Šä½ä¸è§†çª—çš„ä½ç½®ã€‚
    

ä½†è¿™ä¸¤ä¸ªæ–¹æ¡ˆæœ‰ä¸€ä¸ªå¼Šç«¯å°±æ˜¯éƒ½éœ€è¦è°ƒç”¨ Element.getBoundingClientRect()ï¼Œè¿™ä¸ª API åœ¨ä¸»çº¿ç¨‹ä¸Šè¿è¡Œä¸”ä¼šå¼•èµ·é¡µé¢å›æµï¼Œææ˜“æ‹–æ…¢æ•´ä¸ªç½‘ç«™çš„æ€§èƒ½ã€‚

å…¶å®ç»Ÿè®¡æ›å…‰å’Œå›¾ç‰‡æ‡’åŠ è½½ä¸€æ ·ï¼Œéå¸¸é€‚åˆä½¿ç”¨ [IntersectionObserver](https://developer.mozilla.org/zh-CN/docs/Web/API/Intersection_Observer_API) è¿™ä¸ªåŸç”Ÿ APIã€‚

Intersection Observer API ä¼šæ³¨å†Œä¸€ä¸ªå›è°ƒæ–¹æ³•ï¼Œæ¯å½“æœŸæœ›è¢«ç›‘è§†çš„å…ƒç´ è¿›å…¥æˆ–è€…é€€å‡ºå¦å¤–ä¸€ä¸ªå…ƒç´ çš„æ—¶å€™ (æˆ–è€…æµè§ˆå™¨çš„è§†å£) è¯¥å›è°ƒæ–¹æ³•å°†ä¼šè¢«æ‰§è¡Œï¼Œæˆ–è€…ä¸¤ä¸ªå…ƒç´ çš„äº¤é›†éƒ¨åˆ†å¤§å°å‘ç”Ÿå˜åŒ–çš„æ—¶å€™å›è°ƒæ–¹æ³•ä¹Ÿä¼šè¢«æ‰§è¡Œã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼Œç½‘ç«™å°†ä¸éœ€è¦ä¸ºäº†ç›‘å¬ä¸¤ä¸ªå…ƒç´ çš„äº¤é›†å˜åŒ–è€Œåœ¨ä¸»çº¿ç¨‹é‡Œé¢åšä»»ä½•æ“ä½œï¼Œå¹¶ä¸”æµè§ˆå™¨å¯ä»¥å¸®åŠ©æˆ‘ä»¬ä¼˜åŒ–å’Œç®¡ç†ä¸¤ä¸ªå…ƒç´ çš„äº¤é›†å˜åŒ–ã€‚

æ ¹æ®æˆ‘ä»¬çš„éœ€è¦åªè¦é’ˆå¯¹æ€§çš„å†å¢åŠ æ—¶é—´çš„ç»Ÿè®¡å°±å¯ä»¥äº†ã€‚

å®ç°æ€è·¯
----

å°è£… vue æŒ‡ä»¤ï¼Œå¦‚æœä½ ä½¿ç”¨ reactï¼Œä¹Ÿå¯ä»¥ä¿®æ”¹ä¸º hocã€‚

ç”±äº Intersection Observer API [å…¼å®¹æ€§](https://www.caniuse.com/#search=interS)ä¸å¥½ï¼Œå°¤å…¶æ˜¯ IOS 12.2 ä»¥ä¸Šæ‰æ”¯æŒï¼Œæ‰€ä»¥éœ€è¦ä½¿ç”¨å®˜æ–¹çš„ [polyfill å«ç‰‡](https://www.npmjs.com/package/intersection-observer)ã€‚

> â
> 
> é™¤äº†å®Œæˆç°æœ‰çš„éœ€æ±‚ä¹‹å¤–ï¼Œæˆ‘ä»¬åœ¨å¼€å‘æ—¶ä¹Ÿè¦è€ƒè™‘åˆ°å®é™…ä½¿ç”¨ï¼Œä»¥åŠä¸šåŠ¡æ‹“å±•çš„æƒ…å†µã€‚æ¯”å¦‚äº§å“ç»ç†è¦æ±‚æœ‰çš„å¹¿å‘Šä½åªä¸ŠæŠ¥ä¸€æ¬¡ï¼Œæœ‰çš„æ›å…‰ä¸€æ¬¡ä¸ŠæŠ¥ä¸€æ¬¡ï¼Œä¸‹æ‹‰åˆ·æ–°é‡ç½®å½“å‰é¡µé¢æ‰€æœ‰ç»Ÿè®¡ï¼Œè¿˜æœ‰æˆ‘çŒœä¼šä¸ä¼šéœ€è¦æ”¯æŒç¬¬ä¸€æ¬¡æ›å…‰æ—¶é—´æ˜¯ 2 ç§’ï¼Œä¹‹åä¿®æ”¹æ—¶é—´çš„æƒ…å†µï¼Œæ¯•ç«Ÿäº§å“ç»ç†çš„è„‘å›è·¯å’Œå¼€å‘ä¸ä¸€æ ·ï¼Œæˆ‘ä»¬æœ€å¥½çš„æ˜¯åœ¨ç¬¬ä¸€æ¬¡å¼€å‘çš„æ—¶å€™æŠŠè¿™äº›æƒ³åˆ°çš„æƒ…å†µéƒ½è‡ªå·±è¿‡ä¸€éï¼Œåˆç†çš„å°±ä¸€æ¬¡å¼€å‘æ‰ã€‚
> 
> â

ä»£ç å®ç°
----

```Javascript
// observe-exposure.js

/**
 * v-exposure="callback"
 * v-exposure="{callback,time:2000,disabled:false,once:false,intersection:{root:null,rootMargin:'0',threshold:0}}"
 * @description æ›å…‰æŒ‡ä»¤ï¼ˆæ¼å‡ºé¢ç§¯æ¯”ä¾‹ and è¾¾åˆ°å¤šé•¿æ—¶é—´ï¼‰
 * @param {function} callback(entry) æ›å…‰å›è°ƒ
 * @param {object} entry IntersectionObserverEntryå¯¹è±¡
 * @param {number} time @default 2000 æ›å…‰æŒç»­æ—¶é—´
 * @param {boolean} disabled @default false æ˜¯å¦ç¦ç”¨ï¼ˆtrue->false å¯ä»¥é‡æ–°å¼€å¯æ›å…‰æ£€æµ‹ï¼Œä½¿ç”¨æ–¹å¼ï¼šåœ¨callbackæ—¶ç½®ä¸ºtrueï¼Œå½“éœ€è¦é‡æ–°è§‚å¯Ÿæ—¶æ”¹ä¸ºfalseï¼‰
 * @param {boolean} once @default false åªæ›å…‰ä¸€æ¬¡
 * @param {object} intersection IntersectionObserver çš„ option
 */

import 'intersection-observer' // å…¼å®¹ polyfill
import { processCallbackOptions, deepEqual } from './util.js'
IntersectionObserver.prototype['THROTTLE_TIMEOUT'] = 300 // å…¼å®¹æ—¶ èŠ‚æµ 300msè§¦å‘ä¸€æ¬¡

class Exposure {
  constructor (el, options, vnode) {
    this._el = el // è¢«è§‚å¯Ÿå…ƒç´ 
    this._options = null
    this._observer = null // è§‚å¯Ÿè€…
    this._frozen = false // åªè§¦å‘ä¸€æ¬¡æ›å…‰å›è°ƒï¼ˆè®¾ç½®äº†onceï¼‰
    this._timer = null // å®šæ—¶å™¨ID
    this._callback = null // æ›å…‰å›è°ƒ
    this._oldResult = undefined // å‡ºç° or éšè— (å¯¹äºroot)
    this.createObserver(options, vnode) // åˆ›é€ è§‚å¯Ÿè€…
  }

  // æ›å…‰äº¤é›†è¾¹ç•Œå€¼
  get _threshold () {
    return this._options.intersection?.threshold ?? 0
  }

  /**
   * åˆ›é€ è§‚å¯Ÿè€…
   * 1. åˆå§‹åŒ–
   * 2. æŒ‡ä»¤å…¥å‚æ›´æ–°
   */
  createObserver (options, vnode) {
    if (this._observer) {
      // é”€æ¯ä¹‹å‰çš„è§‚å¯Ÿè€…
      this.destroyObserver()
    }
    if (this._frozen) {
      // è®¾ç½®äº†onceï¼Œä¸”å·²ç»æ›å…‰
      return
    }
    // å¤„ç†optionï¼ˆç›´ä¼ callbackå’Œå¯¹è±¡æ¨¡å¼ï¼‰
    this._options = processCallbackOptions(options)
    this._callback = (entry) => {
      // æ›å…‰å›è°ƒ
      this._options.callback(entry)
      if (this._options.once) {
        // è®¾ç½®äº†onceï¼Œåœæ­¢è§‚å¯Ÿ
        this.destroyObserver()
        this._frozen = true
      }
    }
    this._oldResult = undefined
    this._observer = new IntersectionObserver(entries => {
      let entry = entries[0]
      const result = entry.isIntersecting && entry.intersectionRatio >= this._threshold
      if (result !== this._oldResult) {
        this._oldResult = result
        if (result) {
          // æ˜¾ç¤ºï¼ˆå¯¹äºrootï¼‰åˆ‡æ¢
          this._timer = setTimeout(() => {
            this._callback(entry)
          }, this._options.time ?? 2000)
        } else {
          // éšè—ï¼ˆå¯¹äºrootï¼‰åˆ‡æ¢
          clearTimeout(this._timer)
          this._timer = null
        }
      }
    }, this._options.intersection)
    // æ¸²æŸ“å®Œæˆåè§‚å¯Ÿ
    vnode.context.$nextTick(() => {
      this._observer.observe(this._el)
    })
  }
  // é”€æ¯è§‚å¯Ÿè€…
  destroyObserver () {
    if (this._observer) {
      this._observer.disconnect()
      this._observer = null
    }
    if (this._timer) {
      clearTimeout(this._timer)
      this._timer = null
    }
  }

  /**
   * è§£å†»
   * å¯ä»¥ä½¿è®¾ç½®äº†onceçš„å·²æ›å…‰å…ƒç´ é‡æ–°æ¥å—æ›å…‰æ£€æµ‹
   */
  resetFrozen () {
    this._frozen = false
  }
}

export default {
  bind (el, { value }, vnode) {
    if (!value || value?.disabled) return
    if (typeof value === 'function' || ((value instanceof Object) && typeof value.callback === 'function')) {
      const observer = new Exposure(el, value, vnode)
      el._vue_exposure = observer
    } else {
      console.warn('[v-exposure] You should pass in a value of type function or an object containing a callback of type function. ')
    }
  },
  update (el, { value, oldValue }, vnode) {
    // å€¼æœªæ”¹å˜ï¼ˆvnodeæ›´æ–°ï¼‰
    if (deepEqual(value, oldValue)) return
    let observer = el._vue_exposure
    if (observer && (!value || value?.disabled)) {
      observer.destroyObserver()
      return
    }
    if (typeof value === 'function' || ((value instanceof Object) && typeof value.callback === 'function')) {
      if (observer) {
        // æ›´æ–°æŒ‡ä»¤ä¼ å€¼
        if (value?.disabled === false && oldValue.disabled === true) {
          // å¦‚æœè®¾ç½®äº†onceï¼Œåªæœ‰disabledè¢«ä¿®æ”¹ä¸ºfalseï¼Œæ‰ä¼šè§£é™¤å†»ç»“
          // ä¹‹å‰æœªæ›å…‰çš„ä¸å—disabledä¿®æ”¹ä¸ºfalseå½±å“ï¼Œä¼šè¢«createObserver()æ›´æ–°æ›å…‰è®¾ç½®ï¼ˆé‡æ–°ç”Ÿæˆæ–°çš„è§‚å¯Ÿè€…ï¼‰
          // ä¹‹å‰å·²ç»æ›å…‰çš„ä¼šé‡æ–°æ¥å—æ›å…‰æ£€æµ‹ï¼Œä¹Ÿä¼šæ›´æ–°æ–°çš„optionåˆ›å»ºè§‚å¯Ÿè€…
          observer.resetFrozen()
        }
        observer.createObserver(value, vnode)
      } else {
        observer = new Exposure(el, value, vnode)
        el._vue_exposure = observer
      }
    } else {
      console.warn('[v-exposure] You should pass in a value of type function or an object containing a callback of type function. ')
      observer && observer.destroyObserver()
    }
  },
  unbind (el) {
    const observer = el._vue_exposure
    if (observer) {
      observer.destroyObserver()
      delete el._vue_exposure
    }
  }
}
```

```Javascript
// util.js

// å¤„ç†optionï¼ˆç›´ä¼ callbackå’Œå¯¹è±¡æ¨¡å¼ï¼‰
export function processCallbackOptions (value) {
  let options
  if (typeof value === 'function') {
    options = {
      callback: value
    }
  } else {
    options = value
  }
  return options
}

// åˆ¤æ–­ä¸¤å€¼æ˜¯å¦ç›¸ç­‰
export function deepEqual (val1, val2) {
  if (val1 === val2) return true
  if (typeof val1 === 'object') {
    for (const key in val1) {
      if (!deepEqual(val1[key], val2[key])) {
        return false
      }
    }
    return true
  }
  return false
}
```

æœªæ”¯æŒåŠŸèƒ½
-----

*   ç›®å‰æŒ‡ä»¤åšçš„æ˜¯æ»¡è¶³æ¡ä»¶åè°ƒç”¨ä¼ å…¥çš„ callbackï¼Œä½ ä¹Ÿå¯ä»¥æ ¹æ®éœ€è¦æ”¹æˆæŒ‡ä»¤ç›´æ¥è°ƒç”¨ APIï¼ŒæŠŠéœ€è¦ä¸ŠæŠ¥çš„æ•°æ®ä¼ å…¥æŒ‡ä»¤æˆ–è€… dataset
    
*   å¯¹äº ToC é¡¹ç›®ï¼Œç”±äºç”¨æˆ·ä½“é‡å·¨å¤§ä¸å¯èƒ½æ›å…‰ä¸€æ¬¡å°±ä¸ŠæŠ¥ä¸€æ¬¡ï¼Œè¿™æ ·å¯¹æœåŠ¡å™¨å‹åŠ›ğŸä¼šå¾ˆå¤§ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ç¼“å­˜ï¼Œå®šæ—¶æ‰¹é‡ä¸ŠæŠ¥ã€‚
    

> 
> ä»¥ä¸Šç¬¬äºŒç‚¹ï¼Œå®šæ—¶æ‰¹é‡ä¸ŠæŠ¥ä¼šæ¶‰åŠåˆ°ä¸€ç§ç‰¹æ®Šåœºæ™¯ï¼Œå°±æ˜¯å¾…ä¸ŠæŠ¥é˜Ÿåˆ—è¿˜æœªæ¸…ç©ºï¼Œç»“æœç”¨æˆ·å…³é—­äº†æµè§ˆå™¨ / webviewï¼Œå¯¼è‡´ä»£ç æ²¡æ³•æ‰§è¡Œçš„æƒ…å†µã€‚ç›®å‰æƒ³åˆ°å‡ ç§æ–¹æ¡ˆï¼š
> 
> 1. ä¸è€ƒè™‘æ—¶æ•ˆæ€§çš„æƒ…å†µä¸‹ï¼Œå­˜å‚¨åˆ° localStorageï¼Œä¸‹æ¬¡åº”ç”¨å¯åŠ¨æ—¶ä¸ŠæŠ¥ï¼›
> 
> 2. webview ä¸‹è®© native æ”¯æŒåœ¨åå°è¿›ç¨‹ä¸­ä¸ŠæŠ¥
> 
> 3. ä½¿ç”¨ [sendBeacon](https://developer.mozilla.org/zh-CN/docs/Web/API/Navigator/sendBeacon) API
> 

å‚è€ƒæ–‡çŒ®
----

*   [MDN](https://developer.mozilla.org/zh-CN/docs/Web)
    
*   [Vue æŒ‡ä»¤](https://cn.vuejs.org/v2/guide/custom-directive.html)